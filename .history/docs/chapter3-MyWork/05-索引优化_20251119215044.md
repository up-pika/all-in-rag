# 索引优化

## 1. 上下文扩展

LlamaIndex 提出“句子窗口检索”索引策略，解决大块文本与小块文本检索各自存在的短板问题，在检索时聚焦于高度精确的单个句子，在送入LLM生成内容前，又智能地将上下文扩展回一个更宽地“窗口”，同时保证了检索地准确性和生成质量。

句子窗口检索思想：为检索精确性而索引小块，为上下文丰富性而检索大块。

句子窗口检索工作流程：

1. 索引阶段：在构建索引时，文档被分割成单个句子。每个句子都作为一个独立的“节点（Node）”存入向量数据库。同时，每个句子节点都会在元数据（metadata）中存储其上下文窗口，即该句子原文中的前N个和后N个句子。这个窗口内的文本不会被索引，仅仅是作为元数据存储。

2. 检索阶段：当用户发起查询时，系统会在所有单一句子节点上执行相似度搜索。因为句子是表达完整语义的最小单位，所以这种方式可以非常精确地定位到与用户问题最相关的核心信息。

3. 后处理阶段：在检索到最相关的句子节点后，系统会使用一个名为 MetadataReplacementPostProcessor 的后处理模块。该模块会读取到检索到的句子节点的元数据，并用元数据中存储的完整上下文窗口来替换节点中原来的单一句子内容。

4. 生成阶段：最后，这些被替换了内容的、包含丰富上下文的节点被传递给LLM，用于生成最终的答案。

> 简而言之：索引和检索阶段以单个句子为单位，检索成功后，再通过后处理模块，将句子替换为上下文窗口，再送入LLM生成答案。

### 句子窗口检索-实践

学习资料中根据源码分析了LlamaIndex的句子窗口检索实现，提供了一个很好的理解思路。

对比demo代码运行后的结果，两种方案都抓到了核心，句子窗口检索方案的结果更加具有故事感，而常规检索结果呈现的结果直来直去，机械性式回答感突出。

```bash
查询: What are the concerns surrounding the AMOC?

--- 句子窗口检索结果 ---
回答: There is low confidence in understanding changes to the Atlantic meridional overturning circulation (AMOC) during the 20th century due to limited agreement between reconstructed data and model simulations. While continuous observation has improved knowledge of its variability, direct records since the mid-2000s remain too short to determine the contributions of internal variability versus natural and human-caused factors. It is projected with high confidence that the AMOC will decline throughout the 21st century under all shared socioeconomic pathways, though quantitative projections have low confidence and an abrupt collapse before 2100 is not expected.

--- 常规检索结果 ---
回答: The Atlantic Meridional Overturning Circulation (AMOC) is projected to decline throughout the 21st century across all Shared Socioeconomic Pathway scenarios. However, there is high confidence that an abrupt collapse will not occur before the year 2100.

```

## 结构化索引

结构化索引设计旨在精确检索，避免被无关信息干扰。原理在于索引文本块的同时，为其增加结构化的元数据，助于筛选和定位信息。如此，检索时可先根据元数据过滤，缩小范围，然后再进行向量相似度检索，提高检索精确度，降低干扰。

多表格查询的两种检索方案：1. 递归检索；2. 先路由再检索

1. 递归检索实践运行结果

```bash
查询: 1994年评分人数最少的电影是哪一部？
Retrieving with query id None: 1994年评分人数最少的电影是哪一部？
Retrieved node with id, entering: 年份_1994
Retrieving with query id 年份_1994: 1994年评分人数最少的电影是哪一部？
INFO:httpx:HTTP Request: POST https://api.deepseek.com/chat/completions "HTTP/1.1 200 OK"
HTTP Request: POST https://api.deepseek.com/chat/completions "HTTP/1.1 200 OK"
> Pandas Instructions:
```
df[df['年份'] == 1994].nsmallest(1, '评分人数')['电影名称'].iloc[0]
```
> Pandas Output: 燃情岁月
Got response: 燃情岁月
INFO:httpx:HTTP Request: POST https://api.deepseek.com/chat/completions "HTTP/1.1 200 OK"
HTTP Request: POST https://api.deepseek.com/chat/completions "HTTP/1.1 200 OK"
回答: 燃情岁月
```