# 向量数据库

## 1. 定义

**向量数据库（Vector Database）** 是一种专门设计用于高效存储、管理和查询**海量高维向量数据**的数据库系统。与传统数据库处理结构化数据（如数字、文本、日期）不同，向量数据库的核心是处理由嵌入模型生成的**高维向量**（通常维度在数百到数千之间）。

简单理解：向量数据库就像是一个**智能图书馆**，它不仅能存储"书籍"（向量数据），更重要的是能够根据"书籍内容"的相似性快速找到最相关的"书籍"，而不是像传统数据库那样只能通过精确的"书名"（精确匹配）来查找。

## 2. 核心作用

在 RAG（检索增强生成）系统中，向量数据库扮演着**知识库**的角色，是连接原始数据与大语言模型的关键桥梁。**解决一个核心问题:如何快速、准确地从海量向量中找到与用户查询最相似的那几个？（高效处理高维向量的相似性搜索）**。

其主要作用包括：

### 1. 高效的相似性搜索

- **核心能力**：从海量向量中快速找到与查询向量最相似的数据
- **技术实现**：使用专门的索引算法（如HNSW、IVF）实现近似最近邻（ANN）搜索
- **性能表现**：在百万甚至数十亿级别的向量中，实现毫秒级的检索响应

### 2. 高维数据存储与管理

- 专门优化存储高维向量（通常成百上千，如384、768、1024 等维度）
- 支持向量的增、删、改、查等基本操作
- 提供持久化存储，避免每次重新构建索引

### 3. 丰富的查询能力

- **相似性搜索**：基于向量相似度找到相关内容
- **元数据过滤**：在相似性搜索的基础上，支持按标量字段过滤查询（如：`年份 > 2023`、`类别 = "技术文档"`）、范围查询和聚类分析等，满足复杂业务需求

### 4. 可扩展性与高可用

- 采用分布式架构，支持水平扩展
- 通过增加节点应对数据量增长
- 提供容错机制，确保服务稳定可靠

### 5. 数据与模型生态集成

与主流的 AI 框架（如 LangChain, LlamaIndex）和机器学习工作流无缝集成，简化了从模型训练到向量检索的应用开发流程。

## 3. 向量数据库工作原理

### 3.1 为什么需要特殊技术？

在高维向量空间中进行相似性搜索面临巨大挑战：

- **维度灾难**：当向量维度达到数百甚至数千时，传统的数据结构（如 B-Tree）效率急剧下降
- **计算成本**：暴力搜索（遍历所有向量计算相似度）在百万级数据中需要数秒甚至数分钟，无法满足实时查询需求
- **存储压力**：高维向量占用大量存储空间，需要高效的压缩和存储策略

**解决方案**：使用**近似最近邻搜索（ANN, Approximate Nearest Neighbor）**技术，在保证较高召回率的前提下，大幅提升搜索速度。

### 3.2 核心思想：近似最近邻搜索（ANN）

**精确最近邻（Exact Nearest Neighbor）**：遍历所有向量，找到最相似的那个（100% 准确，但太慢）

**近似最近邻（ANN）**：通过智能索引结构，快速找到"很可能"最相似的向量（99%+ 准确率，速度快 100-1000 倍）

**权衡**：用微小的准确率损失（通常 <1%），换取巨大的性能提升（从秒级降到毫秒级）

### 3.3 四层架构

向量数据库通常采用四层架构实现高效相似性搜索：

1. **存储层**：存储向量数据和元数据，优化存储效率，支持分布式存储
2. **索引层**：维护索引算法（HNSW、LSH、IVF 等），创建和优化索引，支持索引调整
3. **查询层**：处理查询请求，支持混合查询（向量搜索 + 元数据过滤），实现查询优化
4. **服务层**：管理客户端连接，提供监控和日志，实现安全管理

### 3.4 主要技术手段

向量数据库通过以下四类索引技术实现高效相似性搜索：

#### 3.4.1 基于树的方法：随机投影树（Annoy）

**工作原理**：

- 构建**二叉树结构**，通过随机投影将向量空间分割
- 每个节点代表一个超平面，将空间分成两部分
- 查询时，从根节点开始，根据查询向量与超平面的关系，选择左子树或右子树，直到叶子节点

**优点**：

- 内存占用小，构建速度快
- 支持动态添加向量

**缺点**：

- 召回率相对较低，需要构建多棵树提升准确率

**应用场景**：中小规模数据，内存受限的场景

**代表产品**：Annoy（Spotify 开源）

#### 3.4.2 基于哈希的方法：LSH（局部敏感哈希）

**工作原理**：

- 使用**特殊的哈希函数**，将相似的向量映射到同一个"桶"中
- 关键特性：**局部敏感性**——相似的向量大概率会被映射到同一个桶，不相似的向量大概率被映射到不同桶
- 查询时，只需在查询向量所在的桶内搜索即可

**优点**：

- 实现简单，查询速度快
- 适合大规模数据

**缺点**：

- 召回率相对较低，需要多个哈希表提升准确率

**应用场景**：大规模数据快速检索，对召回率要求不极致的场景

#### 3.4.3 基于图的方法：HNSW（分层可导航小世界图）

**工作原理**：

- 构建一个**多层图结构**，类似"城市地图"的多层导航系统
- **上层**：稀疏图，包含少量"关键节点"，用于快速定位大致区域
- **下层**：密集图，包含所有向量，用于精确搜索
- **搜索过程**：从上层开始，快速"导航"到目标区域，然后在下层进行精确搜索

**优点**：

- 检索速度极快，召回率高（通常 >95%）
- 特别适合高维数据和低延迟查询场景

**缺点**：

- 内存占用大，构建索引时间较长

**应用场景**：实时推荐、在线搜索、对延迟要求严格的场景

**代表产品**：Milvus、Qdrant、Weaviate

#### 3.4.4 基于量化的方法：IVF（倒排文件索引）

**工作原理**：

- 类似于书籍的**目录索引**系统
- **聚类阶段**：将所有向量通过 K-means 聚类分成多个"桶"（clusters）
- **查询阶段**：
  1. 先找到查询向量最相似的几个"桶"
  2. 只在这些桶内进行精确搜索
  3. 大幅缩小搜索范围，提升速度

**变体**：

- **IVF_FLAT**：桶内向量不压缩，精度最高
- **IVF_SQ8**：桶内向量使用标量量化压缩，节省内存
- **IVF_PQ**：桶内向量使用乘积量化压缩，进一步节省内存

**优点**：

- 性能和资源消耗的平衡之选
- 适合高吞吐量的大规模数据集

**缺点**：

- 召回率不是 100%（相关向量可能在其他桶中）

**应用场景**：通用场景，大规模数据检索

**代表产品**：Faiss、Milvus

### 3.5 相似性度量

向量数据库通过计算向量间的**距离**或**相似度**来判断相似性，常用方法包括：

- **余弦相似度（Cosine Similarity）**：衡量向量方向的相似性，范围 [-1, 1]，值越大越相似
- **欧氏距离（Euclidean Distance / L2）**：衡量向量在空间中的直线距离，值越小越相似
- **内积（Inner Product / Dot Product）**：向量的点积，值越大越相似

不同场景选择不同的度量方式，例如：

- **文本检索**：通常使用余弦相似度（关注语义方向）
- **图像检索**：可能使用欧氏距离（关注特征差异）

### 3.6 工作流程示例

以 HNSW 索引为例，完整的相似性搜索流程：

```text
1. 索引构建阶段：
   原始向量 → 构建多层图结构 → 建立向量间的连接关系 → 保存索引

2. 查询阶段：
   查询文本 → [嵌入模型] → 查询向量 → 
   → 从上层图开始导航 → 快速定位到目标区域 → 
   → 在下层密集图中精确搜索 → 计算相似度排序 → 
   → 返回 Top-K 最相似的向量 → 返回对应的原始文档
```

**性能对比**：

- **暴力搜索**：100万向量，需要计算 100万次相似度，耗时数秒
- **HNSW 索引**：100万向量，只需计算数百次相似度，耗时 <10ms

## 4. 在 RAG 系统中的地位

```text
原始文档 → [嵌入模型] → 向量 → [向量数据库] → 检索相似内容 → [LLM] → 生成答案
```

向量数据库是 RAG 流程中的**核心存储与检索层**：

1. **存储阶段**：将文档通过嵌入模型转换为向量后，存入向量数据库
2. **检索阶段**：用户查询时，将查询文本转换为向量，在向量数据库中快速找到最相关的文档片段
3. **增强生成**：将检索到的相关内容作为上下文，输入给大语言模型生成最终答案

## 5. 向量数据库 vs 传统数据库

| 维度 | 向量数据库 | 传统数据库（RDBMS如 MySQL） |
|------|-----------|----------------------|
| **核心数据类型** | 高维向量（Embeddings） | 结构化数据（文本、数字、日期） |
| **查询方式** | **相似性搜索**（ANN-语义匹配） | **精确匹配**（WHERE age = 25） |
| **索引机制** | HNSW、IVF、LSH 等 ANN 索引 | B-Tree、Hash Index |
| **主要应用场景** | AI 应用、RAG、推荐系统、图像检索、语音识别 | 业务系统、金融交易、数据报表 |
| **数据规模** | 轻松应对千亿级向量 | 通常在千万到亿级行数据，更大规模需复杂分库分表 |
| **性能特点** | 高维数据检索性能极高，计算密集型 | 结构化数据查询快，高维数据查询性能呈指数级下降 |
| **一致性** | 通常为最终一致性 | 强一致性 (ACID 事务) |

**重要提示**：向量数据库和传统数据库是**互补关系**，而非替代关系。在实际应用中，通常将两者结合使用：

- 传统数据库存储业务元数据和结构化信息
- 向量数据库专门处理 AI 模型产生的海量向量数据

## 6. 主流向量数据库

向量数据库市场可以分为两大类：**专用向量数据库**和**支持向量搜索的传统数据库**。根据开源程度，又可分为**开源**和**商业/源码可用**两类。

专用向量数据库是专门为向量搜索而设计的数据库系统，在性能、功能和易用性方面都针对向量场景进行了深度优化。

![向量数据库分类图](../chapter3/images/3_3_1.webp)

当前主流的向量数据库产品包括：

[ **Pinecone** ](https://www.pinecone.io/)是一款完全托管的向量数据库服务，采用Serverless架构设计。它提供存储计算分离、自动扩展和负载均衡等企业级特性，并保证99.95%的SLA。Pinecone支持多种语言SDK，提供极高可用性和低延迟搜索（<100ms），特别适合企业级生产环境、高并发场景和大规模部署。

[ **Milvus** ](https://github.com/milvus-io/milvus)是一款开源的分布式向量数据库，采用分布式架构设计，支持GPU加速和多种索引算法。它能够处理亿级向量检索，提供高性能GPU加速和完善的生态系统。Milvus特别适合大规模部署、高性能要求的场景，以及需要自定义开发的开源项目。

[ **Qdrant** ](https://github.com/qdrant/qdrant)是一款高性能的开源向量数据库，采用Rust开发，支持二进制量化技术。它提供多种索引策略和向量混合搜索功能，能够实现极高的性能（RPS>4000）和低延迟搜索。Qdrant特别适合性能敏感应用、高并发场景以及中小规模部署。

[ **Weaviate** ](https://github.com/weaviate/weaviate)是一款支持GraphQL的AI集成向量数据库，提供20+AI模块和多模态支持。它采用GraphQL API设计，支持RAG优化，特别适合AI开发、多模态处理和快速开发场景。Weaviate具有活跃的社区支持和易于集成的特点。

[ **Chroma** ](https://github.com/chroma-core/chroma)是一款轻量级的开源向量数据库，采用本地优先设计，无依赖。它提供零配置安装、本地运行和低资源消耗等特性，特别适合原型开发、教育培训和小规模应用。Chroma的部署简单，适合快速原型开发。


### 6.2 支持向量搜索的传统数据库

这些数据库原本是通用数据库，后来添加了向量搜索能力，适合需要同时处理结构化数据和向量数据的场景。

#### 6.2.1 开源数据库

**PostgreSQL + pgvector**

- **特点**：PostgreSQL 的向量扩展插件
- **核心优势**：
  - 在现有 PostgreSQL 基础上添加向量能力
  - 支持 SQL 查询，可同时处理结构化数据和向量
  - 成熟稳定，生态丰富
- **适用场景**：已有 PostgreSQL 基础设施，需要混合查询的场景
- **官网**：[pgvector](https://github.com/pgvector/pgvector)

**OpenSearch**

- **特点**：Elasticsearch 的开源分支，支持向量搜索
- **核心优势**：
  - 强大的全文搜索能力 + 向量搜索
  - 分布式架构，可扩展性强
- **适用场景**：需要同时进行全文搜索和向量搜索的场景

**ClickHouse**

- **特点**：列式数据库，支持向量搜索
- **核心优势**：
  - 分析型数据库，查询性能强
  - 支持向量数据类型和相似性搜索
- **适用场景**：数据分析场景，需要向量搜索能力

**Cassandra**

- **特点**：分布式 NoSQL 数据库，支持向量搜索
- **核心优势**：
  - 高可用、可扩展
  - 适合大规模分布式场景
- **适用场景**：大规模分布式系统，需要向量搜索

#### 6.2.2 商业/源码可用数据库

**Elasticsearch**

- **特点**：企业级搜索和分析引擎，支持向量搜索
- **核心优势**：
  - 强大的全文搜索 + 向量搜索
  - 企业级功能完善
- **适用场景**：企业级搜索场景，需要混合搜索能力

**Redis**

- **特点**：内存数据库，支持向量搜索（RedisSearch）
- **核心优势**：
  - 极低延迟
  - 适合缓存和实时场景
- **适用场景**：实时推荐、缓存场景

**Rockset**

- **特点**：实时分析数据库，支持向量搜索
- **核心优势**：
  - 实时数据查询和分析
  - 支持向量搜索
- **适用场景**：实时分析场景，需要向量搜索

**SingleStore**

- **特点**：分布式 SQL 数据库，支持向量搜索
- **核心优势**：
  - SQL 数据库 + 向量搜索
  - 支持混合查询
- **适用场景**：需要 SQL 和向量搜索混合的场景

### 6.3 向量数据库选型指南

选择合适的向量数据库需要综合考虑多个因素：

#### 6.3.1 选型维度

| 维度 | 说明 | 影响 |
|------|------|------|
| **数据规模** | 向量数量级（万级、百万级、亿级） | 决定是否需要分布式架构 |
| **查询性能** | QPS、延迟要求 | 决定索引算法和硬件配置 |
| **部署方式** | 本地部署 vs 云服务 | 决定运维成本和灵活性 |
| **成本预算** | 开源 vs 商业 | 影响总拥有成本（TCO） |
| **技术栈** | 已有基础设施和框架 | 影响集成难度 |
| **功能需求** | 是否需要混合查询、多模态等 | 影响产品选择 |

#### 6.3.2 选型建议

**新手入门/小型项目/原型开发**

- **推荐**：Chroma 或 FAISS
- **理由**：
  - 零配置或简单配置即可使用
  - 与 LangChain/LlamaIndex 集成良好
  - 适合快速验证想法
  - 资源消耗低，本地即可运行

**生产环境/中等规模（百万级向量）**

- **推荐**：Qdrant 或 Milvus（开源） / Pinecone（云服务）
- **理由**：
  - 性能稳定，功能完善
  - 支持高并发查询
  - 有完善的监控和运维工具
  - 社区活跃，问题解决及时

**大规模部署/企业级（亿级向量）**

- **推荐**：Milvus（开源） / Pinecone（云服务）
- **理由**：
  - 支持水平扩展，可处理海量数据
  - 企业级功能完善（高可用、备份恢复等）
  - 性能强劲，支持 GPU 加速
  - 有专业的技术支持

**需要混合查询（结构化数据 + 向量）**

- **推荐**：PostgreSQL + pgvector 或 Elasticsearch
- **理由**：
  - 可在同一数据库中处理结构化数据和向量
  - 支持复杂的 SQL 查询和向量搜索组合
  - 减少系统复杂度

**多模态场景**

- **推荐**：Weaviate 或 Milvus
- **理由**：
  - 原生支持多模态数据
  - 提供丰富的 AI 模块集成

**性能极致要求**

- **推荐**：Qdrant 或 Milvus（GPU 加速）
- **理由**：
  - Qdrant 采用 Rust 开发，性能极高
  - Milvus 支持 GPU 加速，适合大规模场景

#### 6.3.3 快速决策树

```text
开始选型
  │
  ├─ 数据规模 < 10万？
  │   └─ 是 → Chroma 或 FAISS
  │
  ├─ 需要混合查询（结构化+向量）？
  │   └─ 是 → PostgreSQL + pgvector 或 Elasticsearch
  │
  ├─ 预算充足，不想运维？
  │   └─ 是 → Pinecone（云服务）
  │
  ├─ 数据规模 > 亿级？
  │   └─ 是 → Milvus（分布式）
  │
  ├─ 性能要求极高？
  │   └─ 是 → Qdrant 或 Milvus（GPU）
  │
  └─ 其他 → Milvus 或 Qdrant（开源）
```

#### 6.3.4 为什么需要专用向量数据库？

专用向量数据库相比于传统数据库有着明显的优势，主要体现在以下几个方面：

1. **性能要求**
   - 向量搜索需依赖特殊的高维索引算法（如 HNSW、IVF 等），而传统数据库 B-Tree 索引在高维向量检索上效率极低。
2. **规模挑战**
   - 能够支持亿级甚至千亿级别的向量管理与检索。
   - 提供分布式架构与水平扩展能力，能应对大规模数据和高并发请求。
3. **功能需求**
   - 可进行混合查询（向量相似性搜索 + 元数据过滤）。
   - 支持多模态数据（如文本、图片、音频等）的检索与存储，满足实时向量更新和近实时检索的需求。

**类比理解：**

- 专用向量数据库 = 专业相机（为高质量摄影专门优化）
- 支持向量搜索的传统数据库 = 智能手机（拍照只是众多功能之一）

## 练习-实践
### 1. llamaIndex 方案中产生的json文件解析见[索引文件说明](./索引文件说明.md)